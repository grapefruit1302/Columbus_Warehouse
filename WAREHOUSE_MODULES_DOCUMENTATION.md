# Документація модулів складського обліку Columbus Warehouse

## Огляд системи складського обліку

Система складського обліку Columbus Warehouse складається з п'яти взаємопов'язаних модулів, які забезпечують повний цикл управління товарами на складах:

1. **custom_nomenclature** - Номенклатура товарів
2. **custom_stock_receipt** - Документи приходу товарів
3. **stock_batch_management** - Управління партіями товарів
4. **stock_balance_management** - Управління залишками товарів
5. **stock_transfer** - Переміщення товарів

### Загальний робочий процес
1. Створення номенклатури товарів (custom_nomenclature)
2. Оформлення прихідних накладних (custom_stock_receipt)
3. Автоматичне створення партій товарів (stock_batch_management)
4. Ведення залишків по складах та працівниках (stock_balance_management)
5. Переміщення товарів між локаціями (stock_transfer)

---

## 1. Модуль custom_nomenclature - Номенклатура товарів

### Призначення
Модуль призначений для ведення довідника товарів з розширеними можливостями управління одиницями виміру, штрих-кодами та категоріями.

### Основні моделі

#### ProductNomenclature (`product.nomenclature`)
**Опис**: Основна модель для зберігання інформації про товари

**Ключові поля**:
- `code` - Унікальний код товару (автоматично генерується)
- `name` - Назва товару
- `full_name` - Повна назва товару
- `species` - Вид товару (Товар/Послуга/Набір/Генератор/Паливо)
- `tracking_serial` - Облік по серійних номерах (Boolean)
- `barcode` - Штрих-код EAN13
- `barcode_id` - Зв'язок з довідником штрих-кодів
- `base_uom_id` - Базова одиниця виміру
- `category_id` - Категорія товару
- `price_usd`, `price_uah` - Ціни в доларах та гривнях
- `fuel_type` - Тип палива (для ПММ)
- `fuel_consumption_rate` - Норма витрат палива (для генераторів)

**Ключові методи**:
- `_get_next_code()` - Генерація наступного коду товару
- `generate_ean13()` - Генерація унікального штрих-коду EAN13
- `action_assign_barcode()` - Присвоєння штрих-коду товару
- `action_print_label()` - Друк етикетки товару
- `_is_valid_ean13()` - Перевірка валідності штрих-коду
- `action_select_for_disposal()` - Вибір товару для акту оприходування

**Обмеження**:
- Унікальність коду товару
- Унікальність штрих-коду
- Валідація формату EAN13

#### ProductNomenclatureUomLine (`product.nomenclature.uom.line`)
**Опис**: Модель для управління одиницями виміру товару

**Ключові поля**:
- `product_id` - Зв'язок з товаром
- `uom_id` - Одиниця виміру
- `coefficient` - Коефіцієнт перерахунку
- `is_default` - Одиниця за замовчуванням

**Ключові методи**:
- `_check_one_default_uom()` - Перевірка наявності рівно однієї одиниці за замовчуванням
- `_check_coefficient()` - Перевірка коефіцієнта (має бути > 0)
- `_check_duplicate_uom()` - Перевірка унікальності одиниць виміру

#### ProductNomenclatureCategory (`product.nomenclature.category`)
**Опис**: Категорії товарів

#### BarcodeDirectory (`barcode.directory`)
**Опис**: Довідник штрих-кодів

### Представлення (Views)
- Форма редагування товару з вкладками для основної інформації, одиниць виміру та цін
- Список товарів з фільтрами по категоріях та видах
- Модальні вікна для швидкого вибору товарів

### Звіти
- Друк етикеток товарів з штрих-кодами

---

## 2. Модуль custom_stock_receipt - Документи приходу товарів

### Призначення
Модуль призначений для оформлення та обробки прихідних накладних, актів оприходування та повернень товарів.

### Основні моделі

#### StockReceiptIncoming (`stock.receipt.incoming`)
**Опис**: Прихідна накладна для оформлення надходження товарів від постачальників

**Ключові поля**:
- `number` - Номер документа (автоматично генерується)
- `date` - Дата документа
- `supplier_invoice_number` - Номер документа постачальника
- `partner_id` - Постачальник
- `warehouse_id` - Склад призначення
- `company_id` - Компанія
- `no_vat` - Ознака товару без ПДВ
- `state` - Статус (Чернетка/Проведено/Підтверджено/Скасовано)
- `line_ids` - Позиції документа
- `posting_time` - Час проведення
- `posting_datetime` - Дата та час проведення
- `has_serial_products` - Наявність товарів з серійними номерами

**Ключові методи**:
- `_get_default_number()` - Генерація номера документа з префіксом компанії
- `action_post()` - Відкриття майстра для вибору часу проведення
- `_do_posting()` - Виконання проведення документа
- `action_confirm()` - Підтвердження документа
- `action_cancel()` - Скасування документа
- `_get_amount_in_words()` - Перетворення суми в слова українською мовою
- `_get_child_companies_domain()` - Отримання домену дочірніх компаній

**Робочий процес**:
1. Створення документа в статусі "Чернетка"
2. Додавання позицій товарів
3. Проведення документа з вибором часу
4. Підтвердження документа
5. Автоматичне створення партій та оновлення залишків

#### StockReceiptIncomingLine (`stock.receipt.incoming.line`)
**Опис**: Позиція прихідної накладної

**Ключові поля**:
- `receipt_id` - Зв'язок з документом
- `nomenclature_id` - Товар
- `qty` - Кількість
- `selected_uom_id` - Обрана одиниця виміру
- `price_with_vat` - Ціна з ПДВ
- `price_no_vat` - Ціна без ПДВ
- `amount_with_vat` - Сума з ПДВ
- `amount_no_vat` - Сума без ПДВ
- `serial_numbers` - Серійні номери
- `serial_count` - Кількість серійних номерів

**Ключові методи**:
- `_compute_amounts()` - Розрахунок сум
- `action_input_serial_numbers()` - Введення серійних номерів
- `_check_unique_nomenclature()` - Перевірка унікальності товару в документі

#### StockReceiptDisposal (`stock.receipt.disposal`)
**Опис**: Акт оприходування товарів

#### StockReceiptReturn (`stock.receipt.return`)
**Опис**: Документ повернення товарів з сервісу

### Представлення (Views)
- Форма прихідної накладної з вкладками позицій та додаткової інформації
- Список документів з фільтрами по статусах та датах
- Майстри для введення серійних номерів та проведення документів

### Звіти
- Друк прихідної накладної
- Звіт по надходженнях товарів

---

## 3. Модуль stock_batch_management - Управління партіями товарів

### Призначення
Модуль призначений для ведення обліку товарів по партіях з контролем термінів придатності та реалізацією FIFO логіки списання.

### Основні моделі

#### StockBatch (`stock.batch`)
**Опис**: Партія товару з відстеженням руху та термінів придатності

**Ключові поля**:
- `batch_number` - Номер партії (унікальний в межах номенклатури)
- `nomenclature_id` - Товар
- `source_document_type` - Тип документа джерела
- `source_document_id` - ID документа джерела
- `source_document_number` - Номер документа джерела
- `initial_qty` - Початкова кількість
- `current_qty` - Поточна кількість
- `reserved_qty` - Зарезервована кількість
- `available_qty` - Доступна кількість (обчислювана)
- `uom_id` - Одиниця виміру
- `location_id` - Локація зберігання
- `date_created` - Дата створення партії
- `expiry_date` - Дата закінчення терміну придатності
- `is_active` - Активність партії
- `state` - Статус (Активна/Вичерпана/Прострочена/Заблокована)
- `serial_numbers` - Серійні номери товарів у партії

**Ключові методи**:
- `create_batch_from_receipt()` - Створення партії з прихідної накладної
- `reserve_qty()` - Резервування кількості в партії
- `unreserve_qty()` - Скасування резервування
- `consume_qty()` - Списання кількості з партії
- `get_fifo_batches()` - Отримання партій за FIFO для списання
- `action_block_batch()` - Блокування партії
- `action_unblock_batch()` - Розблокування партії
- `_compute_available_qty()` - Обчислення доступної кількості
- `_compute_state()` - Обчислення статусу партії

**FIFO логіка**:
Партії списуються в порядку їх створення (найстаріші першими) для забезпечення правильного обороту товарів.

#### StockBatchMovement (`stock.batch.movement`)
**Опис**: Рух партії товару

**Ключові поля**:
- `batch_id` - Партія
- `movement_type` - Тип руху (Надходження/Списання)
- `operation_type` - Тип операції
- `qty` - Кількість
- `location_from_id` - Локація відправлення
- `location_to_id` - Локація призначення
- `document_reference` - Посилання на документ
- `date` - Дата руху

### Представлення (Views)
- Форма партії з інформацією про рухи та серійні номери
- Список партій з фільтрами по товарах, статусах та термінах придатності
- Звіти по партіях з аналітикою

### Звіти
- Звіт по партіях товарів
- Аналіз термінів придатності
- Рухи по партіях

---

## 4. Модуль stock_balance_management - Управління залишками товарів

### Призначення
Модуль призначений для ведення поточних залишків товарів на складах та у працівників з підтримкою серійних номерів та FIFO логіки.

### Основні моделі

#### StockBalance (`stock.balance`)
**Опис**: Поточні залишки товарів по локаціях

**Ключові поля**:
- `nomenclature_id` - Товар
- `location_type` - Тип локації (Склад/Працівник)
- `warehouse_id` - Склад (для складських залишків)
- `location_id` - Конкретна локація складу
- `employee_id` - Працівник (для особистих залишків)
- `batch_id` - Партія товару
- `qty_on_hand` - Фізична кількість
- `qty_available` - Доступна кількість
- `uom_id` - Одиниця виміру
- `serial_numbers` - Серійні номери товарів
- `serial_count` - Кількість серійних номерів
- `last_update` - Час останнього оновлення

**Ключові методи**:
- `get_balance()` - Отримання поточного залишку
- `update_balance()` - Оновлення залишку товару
- `get_available_qty()` - Отримання доступної кількості
- `check_availability()` - Перевірка доступності товару
- `get_fifo_balances()` - Отримання залишків за FIFO
- `action_view_movements()` - Перегляд рухів по залишку
- `action_view_serials()` - Перегляд серійних номерів
- `_get_serial_numbers_list()` - Розбір серійних номерів

**Унікальність записів**:
Кожен запис залишку унікальний по комбінації: товар + тип локації + локація + партія + компанія

#### StockBalanceSerialLine (`stock.balance.serial.line`)
**Опис**: Тимчасова модель для відображення серійних номерів у вигляді списку

#### StockBalanceMovement (`stock.balance.movement`)
**Опис**: Рухи залишків товарів

### Представлення (Views)
- Форма залишку з детальною інформацією про серійні номери
- Список залишків з фільтрами по товарах, локаціях та партіях
- Аналітичні звіти по залишках

### Інтеграція
Модуль інтегрується з усіма іншими модулями для автоматичного оновлення залишків при:
- Проведенні прихідних накладних
- Списанні товарів
- Переміщеннях між локаціями

---

## 5. Модуль stock_transfer - Переміщення товарів

### Призначення
Модуль призначений для оформлення та обробки переміщень товарів між складами та працівниками.

### Основні моделі

#### StockTransfer (`stock.transfer`)
**Опис**: Документ переміщення товарів

**Ключові поля**:
- `number` - Номер документа
- `date` - Дата документа
- `company_id` - Компанія
- `transfer_type` - Тип переміщення:
  - `warehouse` - Між складами
  - `employee` - Між працівниками
  - `warehouse_employee` - Зі складу працівнику
  - `employee_warehouse` - Від працівника на склад
- `warehouse_from_id` - Склад відправник
- `warehouse_to_id` - Склад одержувач
- `employee_from_id` - Працівник відправник
- `employee_to_id` - Працівник одержувач
- `state` - Статус (Чернетка/Підтверджено/Виконано/Скасовано)
- `line_ids` - Позиції переміщення
- `posting_datetime` - Час проведення

**Ключові методи**:
- `action_confirm()` - Підтвердження документа
- `action_done()` - Виконання переміщення
- `action_cancel()` - Скасування документа
- `_get_child_companies()` - Отримання дочірніх компаній
- `action_debug_balances()` - Дебаг залишків для розробки

#### StockTransferLine (`stock.transfer.line`)
**Опис**: Позиція переміщення товару

**Ключові поля**:
- `transfer_id` - Документ переміщення
- `nomenclature_id` - Товар
- `available_nomenclature_ids` - Доступні товари (обчислювана)
- `available_qty` - Доступна кількість
- `qty` - Кількість для переміщення
- `selected_uom_id` - Обрана одиниця виміру
- `batch_id` - Партія товару
- `serial_numbers` - Серійні номери

**Ключові методи**:
- `_compute_available_nomenclature_ids()` - Обчислення доступних товарів
- `_get_child_companies()` - Отримання дочірніх компаній для пошуку залишків

### Представлення (Views)
- Форма переміщення з динамічними полями залежно від типу
- Список документів переміщення з фільтрами
- Майстри для вибору товарів та партій

### Інтеграція з іншими модулями
- Перевірка доступності товарів через stock_balance_management
- Автоматичне оновлення залишків при виконанні переміщення
- Інтеграція з партіями через stock_batch_management

---

## Взаємозв'язки між модулями

### Залежності модулів
1. **custom_nomenclature** - базовий модуль (залежить тільки від stock, uom, mail)
2. **custom_stock_receipt** - залежить від custom_nomenclature та інших базових модулів
3. **stock_batch_management** - залежить від custom_nomenclature та custom_stock_receipt
4. **stock_balance_management** - залежить від усіх попередніх модулів
5. **stock_transfer** - залежить від базових модулів та інтегрується з іншими

### Потік даних
1. **Створення товару** → custom_nomenclature
2. **Надходження товару** → custom_stock_receipt → автоматичне створення партії (stock_batch_management) → оновлення залишків (stock_balance_management)
3. **Переміщення товару** → stock_transfer → оновлення залишків у різних локаціях

### Ключові інтеграційні точки
- Автоматичне створення партій при проведенні прихідних накладних
- Оновлення залишків при всіх операціях з товарами
- FIFO логіка списання через партії та залишки
- Контроль доступності товарів при переміщеннях

---

## Безпека та права доступу

### Рівні доступу
- Читання залишків та партій
- Створення та редагування документів
- Проведення та підтвердження операцій
- Адміністрування довідників

### Обмеження по компаніях
Всі модулі підтримують мультикомпанійність з автоматичною фільтрацією даних по компаніях користувача.

---

## Технічні особливості

### Послідовності номерів
- Автоматична генерація номерів документів з префіксами компаній
- Підтримка діапазонів дат для послідовностей

### Відстеження змін
- Всі основні моделі наслідують mail.thread для відстеження змін
- Автоматичне логування операцій з товарами

### Продуктивність
- Індексація ключових полів для швидкого пошуку
- Оптимізовані запити для обчислення залишків
- Кешування обчислюваних полів

Ця документація покриває основну функціональність п'яти модулів складського обліку Columbus Warehouse. Кожен модуль має свою специфіку, але разом вони утворюють цілісну систему управління складськими операціями.
